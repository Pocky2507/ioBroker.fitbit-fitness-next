<html>
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="../../css/adapter.css" />
    <link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css" />
    <script type="text/javascript" src="../../lib/js/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="../../socket.io/socket.io.js"></script>
    <script type="text/javascript" src="../../js/translate.js"></script>
    <script type="text/javascript" src="../../lib/js/materialize.js"></script>
    <script type="text/javascript" src="../../js/adapter-settings.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css" />
    <script type="text/javascript" src="words.js"></script>

        <script type="text/javascript">
      var oauthPopup = null;
      var currentClientId = null;
      var currentClientSecret = null;
      var currentRedirectUri = null;
      var tokenListenerInitialized = false;

      function openAuthPopup(url) {
        try {
          if (oauthPopup && !oauthPopup.closed) oauthPopup.close();
        } catch (e) {}
        oauthPopup = window.open(
          url,
          "fitbitAuth",
          "width=850,height=850,menubar=no,toolbar=no,location=yes,status=no"
        );
      }

      function closeAuthPopup(hintWin) {
        try {
          if (hintWin && typeof hintWin.close === "function") hintWin.close();
        } catch (e) {}
        try {
          if (oauthPopup && !oauthPopup.closed) oauthPopup.close();
        } catch (e) {}
        oauthPopup = null;
      }

      function valid(s) {
        return s && typeof s === "string" && s.trim() !== "";
      }

      function initTokenListener() {
        if (tokenListenerInitialized) return;

        var eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
        var eventer = window[eventMethod];
        var messageEvent = eventMethod === "attachEvent" ? "onmessage" : "message";

        eventer(messageEvent, function (e) {
          if (!e.data || !e.data.code) return;

          if (!currentClientId || !currentClientSecret || !currentRedirectUri) {
            alert("Client ID / Secret / Redirect URL nicht gesetzt. Bitte erneut auf 'Authorize' klicken.");
            return;
          }

          var authCode = e.data.code;

          var urlEncoded =
            "grant_type=authorization_code" +
            "&clientId=" + encodeURIComponent(currentClientId) +
            "&redirect_uri=" + encodeURIComponent(currentRedirectUri) +
            "&code=" + encodeURIComponent(authCode);

          $.ajax({
            url: "https://api.fitbit.com/oauth2/token",
            type: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "Authorization": "Basic " + btoa(currentClientId + ":" + currentClientSecret),
            },
            data: urlEncoded
          })
            .done(function (data) {
              var time = new Date();
              if (data && data.expires_in) {
                time.setSeconds(time.getSeconds() + data.expires_in);
              }

              // Tokens im ioBroker-Objektbaum speichern (Instanz 0)
              socket.emit("setState", "fitbit-fitness-next.0.tokens.access", data.access_token, true);
              socket.emit("setState", "fitbit-fitness-next.0.tokens.refresh", data.refresh_token, true);
              socket.emit("setState", "fitbit-fitness-next.0.tokens.expire", time.toISOString(), true);

              $("#accessToken").val(data.access_token || "");
              $("#refreshToken").val(data.refresh_token || "");
              $("#expireOn").val(time.toISOString());

              if (M) M.updateTextFields();
              closeAuthPopup();
              alert("Token erfolgreich aktualisiert.");
            })
            .fail(function (err) {
              var msg = "Fehler beim Abrufen des Tokens.";
              if (err && err.responseText) {
                msg += " " + err.responseText;
              }
              alert(msg);
            });
        }, false);

        tokenListenerInitialized = true;
      }

      function load(settings, onChange) {
        if (!settings) return;

        $(".value").each(function () {
          const $el = $(this);
          const id = $el.attr("id");

          if ($el.is("select")) {
            // SELECT
            $el.val(settings[id]).on("change", () => onChange());
          } else if ($el.attr("type") === "checkbox") {
            // CHECKBOX
            $el.prop("checked", settings[id]).on("change", () => onChange());
          } else {
            // TEXT, NUMBER, ETC.
            $el.val(settings[id]).on("change", () => onChange()).on("keyup", () => onChange());
          }
        });

        // Materialize Select aktivieren
        setTimeout(() => {
          if (typeof M !== "undefined" && M && M.FormSelect) $("select").formSelect();
        }, 50);

        // Collapsible (Akkordeon) f√ºr Token-Verwaltung aktivieren
        setTimeout(() => {
          if (typeof M !== "undefined" && M && M.Collapsible && $(".collapsible").length) {
            $(".collapsible").collapsible();
          }
        }, 100);

        // Token-Listener initialisieren
        initTokenListener();

        $(".table-button-do").on("click", function () {
          var clientId = $("#clientId").val().trim();
          var clientSecret = $("#clientSecret").val().trim();
          var redirectUri = $("#redirectUri").val().trim();

          if (!valid(clientId) || !valid(clientSecret) || !valid(redirectUri)) {
            alert("Bitte Client ID, Client Secret und Redirect URL zuerst speichern.");
            return;
          }

          // aktuelle Werte f√ºr den Token-Austausch merken
          currentClientId = clientId;
          currentClientSecret = clientSecret;
          currentRedirectUri = redirectUri;

          var url =
            "https://www.fitbit.com/oauth2/authorize" +
            "?response_type=code" +
            "&client_id=" +
            encodeURIComponent(clientId) +
            "&redirect_uri=" +
            encodeURIComponent(redirectUri) +
            "&scope=" +
            encodeURIComponent(
              "activity heartrate location nutrition profile settings sleep social weight"
            ) +
            "&expires_in=2592000000";

          openAuthPopup(url);
        });

        // Vorhandene Tokens aus ioBroker laden und anzeigen
        socket.emit("getState", "fitbit-fitness-next.0.tokens.access", function (err, state) {
          $("#accessToken").val(state && state.val ? state.val : "");
        });
        socket.emit("getState", "fitbit-fitness-next.0.tokens.refresh", function (err, state) {
          $("#refreshToken").val(state && state.val ? state.val : "");
        });
        socket.emit("getState", "fitbit-fitness-next.0.tokens.expire", function (err, state) {
          $("#expireOn").val(state && state.val ? state.val : "");
        });

        if (typeof M !== "undefined" && M) M.updateTextFields();
        onChange(false);
      }

      function save(callback) {
        var obj = {};

        $(".value").each(function () {
          const $el = $(this);
          const id = $el.attr("id");

          if ($el.is("select")) {
            obj[id] = $el.val();
          } else if ($el.attr("type") === "checkbox") {
            obj[id] = $el.prop("checked");
          } else if ($el.attr("type") === "number") {
            obj[id] = parseFloat($el.val());
          } else {
            obj[id] = $el.val();
          }
        });

        callback(obj);
      }
    </script>
  </head>

  <body>
    <div class="m adapter-container">
      <div class="row">
        <div class="col s12">
          <ul class="tabs">
            <li class="tab col s2"><a href="#tab-main" class="translate active">Haupteinstellungen</a></li>
            <li class="tab col s2"><a href="#tab-services" class="translate">Dienste</a></li>
            <li class="tab col s2"><a href="#tab-mainsleep" class="translate">Hauptschlaf</a></li>
            <li class="tab col s2"><a href="#tab-naps" class="translate">Nickerchen</a></li>
            <li class="tab col s2"><a href="#tab-debug" class="translate">Debug & KI</a></li>
          </ul>
        </div>

        <!-- MAIN TAB -->
        <div id="tab-main" class="col s12 page">
          <div class="row"><div class="col s6"><img src="fitbit-fitness-next.png" class="logo" /></div></div>

          <div class="row">
            <div class="input-field col s12 m6">
              <input class="value" id="clientId" type="text" placeholder="Deine Client ID" />
              <label for="clientId">Client ID</label>
            </div>

            <div class="input-field col s12 m6">
              <input class="value" id="clientSecret" type="text" placeholder="Dein Client Secret" />
              <label for="clientSecret">Client Secret</label>
            </div>
          </div>

          <div class="row">
            <div class="input-field col s12">
              <input
                class="value"
                id="redirectUri"
                type="text"
                placeholder="https://pocky2507.github.io/ioBroker.fitbit-fitness-next/getCode.html"
              />
              <label for="redirectUri">Redirect URL</label>
            </div>
          </div>

          <div class="row generate no-iframe">
            <a class="waves-effect waves-light btn blue table-button-do">
              <i class="material-icons">add</i><span class="translate">Authorize</span>
            </a>
          </div>
        
          <ul class="collapsible">
            <li>
              <div class="collapsible-header">
                <i class="material-icons">vpn_key</i>
                <span class="translate">Token-Verwaltung</span>
              </div>
              <div class="collapsible-body">
                <div class="row no-iframe">
                  <div class="input-field col s12 m6">
                    <input id="accessToken" type="text" readonly />
                    <label for="accessToken" class="translate">Access Token</label>
                  </div>
                  <div class="input-field col s12 m6">
                    <input id="refreshToken" type="text" readonly />
                    <label for="refreshToken" class="translate">Refresh Token</label>
                  </div>
                </div>
                <div class="row no-iframe">
                  <div class="input-field col s12 m6">
                    <input id="expireOn" type="text" readonly />
                    <label for="expireOn" class="translate">Token l√§uft ab am</label>
                  </div>
                </div>
              </div>
            </li>
          </ul></div>

        <!-- SERVICES TAB -->
        <div id="tab-services" class="col s12 page">
          <div class="row"><div class="col s6"><img src="fitbit-fitness-next.png" class="logo" /></div></div>

          <div class="row no-iframe">
            <div class="input-field col s3">
              <i class="material-icons prefix">refresh</i>
              <input class="value" id="refresh" type="number" placeholder="10" />
              <label for="refresh" class="translate">Abfrageintervall (Minuten)</label>
            </div>
          </div>

          <div class="row"><div class="col s12"><h6>üíæ Datendienste</h6></div></div>

          <div class="row"><div class="input-field col s12 m6 l4"><input class="value" id="bodyrecords" type="checkbox" /><span class="translate">K√∂rperdaten abrufen (bodyrecords)</span></div></div>
          <div class="row"><div class="input-field col s12 m6 l4"><input class="value" id="activityrecords" type="checkbox" /><span class="translate">Aktivit√§tsdaten abrufen (activityrecords)</span></div></div>
          <div class="row"><div class="input-field col s12 m6 l4"><input class="value" id="intraday" type="checkbox" /><span class="translate">Intraday-Daten abrufen</span></div></div>
          <div class="row"><div class="input-field col s12 m6 l4"><input class="value" id="foodrecords" type="checkbox" /><span class="translate">Ern√§hrungsdaten abrufen (foodrecords)</span></div></div>
          <div class="row"><div class="input-field col s12 m6 l4"><input class="value" id="devicerecords" type="checkbox" /><span class="translate">Ger√§tedaten abrufen (devicerecords)</span></div></div>
        </div>

        <!-- MAIN SLEEP TAB -->
        <div id="tab-mainsleep" class="col s12 page">
          <div class="row"><div class="col s6"><img src="fitbit-fitness-next.png" class="logo" /></div></div>

          <div class="row"><div class="col s12"><h6>üõèÔ∏è Hauptschlaf-Erfassung</h6></div></div>

          <div class="row">
            <div class="input-field col s12 m6 l4">
              <input class="value" id="sleeprecords" type="checkbox" />
              <span class="translate">Schlafdaten regelm√§√üig abrufen</span>
            </div>

            <div class="input-field col s6">
              <input class="value" id="sleeprecordsschedule" type="checkbox" />
              <span class="translate">Nur einmaligen Schlafabruf durchf√ºhren</span>
            </div>
          </div>

          <div class="row"><div class="col s12"><h6>üåô Fr√ºhschlaf-Filter</h6></div></div>

          <div class="row">
            <div class="input-field col s12 m6 l4">
              <input class="value" id="ignoreEarlyMainSleepEnabled" type="checkbox" />
              <span class="translate">Fr√ºhen Hauptschlaf ignorieren</span>
            </div>
          </div>

          <div class="row">
            <div class="input-field col s12 m6 l4">
              <i class="material-icons prefix">schedule</i>
              <input class="value" id="ignoreEarlyMainSleepTime" type="text" placeholder="23:00" />
              <label class="translate">Grenzzeit f√ºr Fr√ºhschlaf</label>
            </div>
          </div>

          <div class="row"><div class="col s12"><h6>üß† Erweiterte Schlaflogik</h6></div></div>

          <div class="row"><div class="input-field col s12 m6 l4"><input class="value" id="smartEarlySleepEnabled" type="checkbox" /><span class="translate">Intelligente Fr√ºhschlaf-Erkennung aktivieren</span></div></div>

          <div class="row">
            <div class="input-field col s12 m6 l4">
              <i class="material-icons prefix">access_time</i>
              <input class="value" id="minMainSleepHours" type="number" min="1" max="6" step="0.5" placeholder="3" />
              <label class="translate">Minimale Hauptschlafdauer (Stunden)</label>
            </div>
          </div>

          <div class="row">
            <div class="input-field col s12 m6 l4">
              <i class="material-icons prefix">timelapse</i>
              <input class="value" id="sleepStabilityMinutes" type="number" min="5" max="60" step="1" placeholder="20" />
              <label class="translate">Schlaf-Stabilit√§t (Minuten)</label>
            </div>
          </div>

          <div class="row">
            <div class="input-field col s12 m6 l4">
              <i class="material-icons prefix">alarm_on</i>
              <input class="value" id="sleepLateWakeCorrectionMinutes" type="number" min="0" max="120" step="5" placeholder="0" />
              <label class="translate">Korrektur versp√§teter Aufwachzeit (Minuten)</label>
            </div>
          </div>
        </div>

        <!-- NAPS TAB -->
        <div id="tab-naps" class="col s12 page">
          <div class="row"><div class="col s6"><img src="fitbit-fitness-next.png" class="logo" /></div></div>

          <div class="row"><div class="col s12"><h6>üïí Nickerchen-Einstellungen</h6></div></div>

          <div class="row"><div class="input-field col s12 m6 l4"><input class="value" id="showLastOrFirstNap" type="checkbox" /><span class="translate">Letztes oder erstes Nickerchen anzeigen</span></div></div>

          <div class="row"><div class="input-field col s12 m6 l4"><input class="value" id="clearNapListAtNight" type="checkbox" /><span class="translate">Nickerchen-Liste nachts l√∂schen</span></div></div>

          <div class="row"><div class="input-field col s12 m6 l4"><input class="value" id="enableDailyNapClear" type="checkbox" /><span class="translate">T√§gliches automatisches L√∂schen aktivieren</span></div></div>

          <div class="row">
            <div class="input-field col s12 m6 l4">
              <i class="material-icons prefix">access_time</i>
              <input class="value" id="forceClearNapListTime" type="text" placeholder="02:45" />
              <label class="translate">Zeitpunkt zum L√∂schen der Nap-Liste</label>
            </div>
          </div>

          <div class="row"><div class="col s12"><h6>üß† Erweiterte Nickerchen-Erkennung</h6></div></div>

          <div class="row"><div class="input-field col s12 m6 l4"><input class="value" id="smartNapValidationEnabled" type="checkbox" /><span class="translate">Intelligente Nickerchen-Erkennung aktivieren</span></div></div>
        </div>

        <!-- DEBUG & KI TAB -->
        <div id="tab-debug" class="col s12 page">
          <div class="row"><div class="col s6"><img src="fitbit-fitness-next.png" class="logo" /></div></div>

          <div class="row"><div class="col s12"><h6>üêû Debug & üß† KI-Analyse</h6></div></div>

          <div class="row">
            <div class="input-field col s12 m6 l4">
              <input class="value" id="debugEnabled" type="checkbox" />
              <span class="translate">Debug-Ausgabe aktivieren</span>
            </div>
          </div>

          <div class="row"><div class="col s12"><h6>üß† KI-Analyse (Beta)</h6></div></div>

          <div class="row">
            <div class="input-field col s12 m6 l4">
              <input class="value" id="kiEnabled" type="checkbox" />
              <span class="translate">KI-Analyse aktivieren</span>
            </div>
          </div>

          <div class="row">
            <div class="input-field col s12 m6 l4">
              <select class="value" id="kiMode">
                <option value="disabled">Aus (Standard)</option>
                <option value="soft">Soft ‚Äì nur Hinweise</option>
                <option value="adaptive">Adaptiv ‚Äì Korrekturen mit History</option>
                <option value="strict">Strict ‚Äì KI hat Vorrang</option>
              </select>
              <label class="translate" for="kiMode">KI-Betriebsmodus</label>
            </div>
          </div>

          <p class="col s12 grey-text text-darken-1 translate">
            Die KI-Analyse ist eine fortgeschrittene Funktion, die pers√∂nliche Schlafmuster automatisch
            aus der History erkennt. Standardm√§√üig deaktiviert.
          </p>
        </div>
      </div>
    </div>
  </body>
</html>
