<html>
<head>
  <link rel="stylesheet" type="text/css" href="../../css/adapter.css" />
  <link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css">
  <script type="text/javascript" src="../../lib/js/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="../../socket.io/socket.io.js"></script>
  <script type="text/javascript" src="../../js/translate.js"></script>
  <script type="text/javascript" src="../../lib/js/materialize.js"></script>
  <script type="text/javascript" src="../../js/adapter-settings.js"></script>
  <link rel="stylesheet" type="text/css" href="style.css" />
  <script type="text/javascript" src="words.js"></script>

  <script type="text/javascript">
    var oauthPopup = null;
    function openAuthPopup(url) {
      try { if (oauthPopup && !oauthPopup.closed) oauthPopup.close(); } catch(e) {}
      oauthPopup = window.open(url, "fitbitAuth", "width=850,height=850,menubar=no,toolbar=no,location=yes,status=no");
    }
    function closeAuthPopup(hintWin) {
      try { if (hintWin && typeof hintWin.close === 'function') hintWin.close(); } catch(e){}
      try { if (oauthPopup && !oauthPopup.closed) oauthPopup.close(); } catch(e){}
      oauthPopup = null;
    }
    function valid(s){ return s && typeof s === 'string' && s.trim() !== ''; }

    function load(settings, onChange) {
      if (!settings) return;

      $('.value').each(function () {
        var $el = $(this), id = $el.attr('id');
        if ($el.attr('type') === 'checkbox') {
          $el.prop('checked', settings[id]).on('change', () => onChange());
        } else {
          $el.val(settings[id]).on('change', () => onChange()).on('keyup', () => onChange());
        }
      });

      $('.table-button-do').on('click', function () {
        var clientId     = $('#clientId').val().trim();
        var clientSecret = $('#clientSecret').val().trim();
        var redirectUri  = $('#redirectUri').val().trim();

        if (!valid(clientId) || !valid(clientSecret) || !valid(redirectUri)) {
          alert('Bitte Client ID, Client Secret und Redirect URL zuerst speichern.');
          return;
        }

        var url = 'https://www.fitbit.com/oauth2/authorize'
          + '?response_type=code'
          + '&client_id=' + encodeURIComponent(clientId)
          + '&redirect_uri=' + encodeURIComponent(redirectUri)
          + '&scope=' + encodeURIComponent('activity heartrate location nutrition profile settings sleep social weight')
          + '&expires_in=2592000000';

        openAuthPopup(url);
      });

      var eventMethod = window.addEventListener ? 'addEventListener' : 'attachEvent';
      var eventer = window[eventMethod];
      var messageEvent = eventMethod === 'attachEvent' ? 'onmessage' : 'message';

      eventer(messageEvent, function (e) {
        var clientId     = $('#clientId').val().trim();
        var clientSecret = $('#clientSecret').val().trim();
        var redirectUri  = $('#redirectUri').val().trim();

        if (!valid(clientId) || !valid(clientSecret) || !valid(redirectUri)) {
          closeAuthPopup(e && e.source);
          return;
        }

        try {
          var allowedOrigin = new URL(redirectUri).origin;
          if (allowedOrigin && e.origin !== allowedOrigin) return;
        } catch(_) {}

        if (!e.data) { closeAuthPopup(e.source); return; }

        if (e.data.error) {
          try { M && M.toast && M.toast({html: 'Fitbit-Anmeldung abgebrochen'}); } catch(_){}
          closeAuthPopup(e.source);
          return;
        }

        if (e.data.code) {
          var body = 'grant_type=authorization_code'
            + '&client_id=' + encodeURIComponent(clientId)
            + '&redirect_uri=' + encodeURIComponent(redirectUri)
            + '&code=' + encodeURIComponent(e.data.code);

          $.ajax({
            url: 'https://api.fitbit.com/oauth2/token',
            type: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'Authorization': 'Basic ' + btoa(clientId + ':' + clientSecret),
            },
            data: body
          }).done(function (data) {
            var time = new Date();
            time.setSeconds(time.getSeconds() + data.expires_in);

            socket.emit('setState', 'fitbit-fitness.' + instance + '.tokens.access',  data.access_token,  true);
            socket.emit('setState', 'fitbit-fitness.' + instance + '.tokens.refresh', data.refresh_token, true);
            socket.emit('setState', 'fitbit-fitness.' + instance + '.tokens.expire',  time.toISOString(), true);

            $('#accessToken').val(data.access_token);
            $('#refreshToken').val(data.refresh_token);
            $('#expireOn').val(time.toISOString());

            try { M && M.updateTextFields && M.updateTextFields(); } catch(_){}
            try { M && M.toast && M.toast({html: 'Token aktualisiert'}); } catch(_){}
            closeAuthPopup(e.source);
          }).fail(function (err) {
            alert("Token exchange failed: " + (err && err.responseText ? err.responseText : err));
            closeAuthPopup(e.source);
          });
        } else {
          closeAuthPopup(e.source);
        }
      }, false);

      socket.emit('getState', 'fitbit-fitness.' + instance + '.tokens.access', function (err, state) {
        $('#accessToken').val(state ? state.val || '' : '');
      });
      socket.emit('getState', 'fitbit-fitness.' + instance + '.tokens.refresh', function (err, state) {
        $('#refreshToken').val(state ? state.val || '' : '');
      });
      socket.emit('getState', 'fitbit-fitness.' + instance + '.tokens.expire', function (err, state) {
        $('#expireOn').val(state ? state.val || '' : '');
        if (state && state.val) { $('.table-button-do span').html(_('Update token')); }
        setTimeout(function () { if (M) M.updateTextFields(); }, 500);
      });

      var $sleeprecords = $('#sleeprecords');
      $sleeprecords.on('change', function () {
        var val = $(this).prop('checked');
        if (val) { $('.sleepschedule').show(); } else { $('.sleepschedule').hide(); onChange(); }
      });

      onChange(false);
      if (M) M.updateTextFields();
    }

    function save(callback) {
      var obj = {};
      $('.value').each(function () {
        var $this = $(this);
        if ($this.attr('type') === 'checkbox') {
          obj[$this.attr('id')] = $this.prop('checked');
        } else if ($this.attr('type') === 'number') {
          obj[$this.attr('id')] = parseFloat($this.val());
        } else {
          obj[$this.attr('id')] = $this.val();
        }
      });
      callback(obj);
    }
  </script>
</head>

<body>
  <div class="m adapter-container">
    <div class="row">
      <div class="col s12">
        <ul class="tabs">
          <li class="tab col s2"><a href="#tab-main" class="translate active">Main settings</a></li>
          <li class="tab col s2"><a href="#tab-services" class="translate">Services</a></li>
          <li class="tab col s2"><a href="#tab-debug" class="translate">Debug & Optionen</a></li>
        </ul>
      </div>

      <!-- MAIN TAB -->
      <div id="tab-main" class="col s12 page">
        <div class="row">
          <div class="col s6"><img src="fitbit-fitness.png" alt="logo" class="logo"></div>
        </div>
        <div class="row">
          <div class="input-field col s12 m6">
            <input class="value" id="clientId" type="text" placeholder="Deine Client ID">
            <label for="clientId">Client ID</label>
          </div>
          <div class="input-field col s12 m6">
            <input class="value" id="clientSecret" type="text" placeholder="Dein Client Secret">
            <label for="clientSecret">Client Secret</label>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12">
            <input class="value" id="redirectUri" type="text" placeholder="https://pocky2507.github.io/ioBroker.fitbit-fitness/getCode.html">
            <label for="redirectUri">Redirect URL</label>
          </div>
        </div>
        <div class="row generate no-iframe">
          <a class="waves-effect waves-light btn blue table-button-do">
            <i class="material-icons">add</i><span class="translate">Authorize</span>
          </a>
        </div>
        <div class="row tokens generate no-iframe">
          <div class="input-field col s22">
            <i class="material-icons prefix">account_circle</i>
            <input id="accessToken" type="text" readonly>
            <label for="accessToken" class="translate">accessToken</label>
          </div>
        </div>
        <div class="row tokens generate no-iframe">
          <div class="input-field col s22">
            <i class="material-icons prefix">account_circle</i>
            <input id="refreshToken" type="text" readonly>
            <label for="refreshToken" class="translate">Refresh token</label>
          </div>
        </div>
        <div class="row tokens generate no-iframe">
          <div class="input-field col s12 m6 24">
            <i class="material-icons prefix">timelapse</i>
            <input id="expireOn" type="text" readonly>
            <label for="expireOn" class="translate">Expires on</label>
          </div>
        </div>
      </div>

      <!-- SERVICES TAB -->
      <div id="tab-services" class="col s12 page">
        <div class="row">
          <div class="col s6"><img src="fitbit-fitness.png" alt="logo" class="logo"></div>
        </div>
        <div class="row no-iframe">
          <div class="input-field col s3">
            <i class="material-icons prefix">refresh</i>
            <input class="value" id="refresh" type="number" placeholder="10">
            <label for="refresh" class="translate">refresh</label>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12 m6 l4">
            <input class="value" id="bodyrecords" type="checkbox">
            <span for="bodyrecords" class="translate">bodyrecords</span>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12 m6 l4">
            <input class="value" id="activityrecords" type="checkbox">
            <span for="activityrecords" class="translate">activityrecords</span>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12 m6 l4">
            <input class="value" id="intraday" type="checkbox">
            <span for="intraday" class="translate">intraday</span>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s3 m6 l4">
            <input class="value" id="sleeprecords" type="checkbox">
            <span for="sleeprecords" class="translate">sleeprecords</span>
          </div>
          <div class="input-field sleepschedule col s6">
            <input class="value" id="sleeprecordsschedule" type="checkbox">
            <span for="sleeprecordsschedule" class="translate">sleeprecordsschedule</span>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12 m6 l4">
            <input class="value" id="foodrecords" type="checkbox">
            <span for="foodrecords" class="translate">foodrecords</span>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12 m6 l4">
            <input class="value" id="devicerecords" type="checkbox">
            <span for="devicerecords" class="translate">devicerecords</span>
          </div>
        </div>
        <div class="row">
          <div class="col s12"><h6>ðŸ•’ Nickerchen-Einstellungen</h6></div>
        </div>
        <div class="row">
          <div class="input-field col s12 m6 l4">
            <input class="value" id="showLastOrFirstNap" type="checkbox">
            <span for="showLastOrFirstNap" class="translate">showLastOrFirstNap</span>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12 m6 l4">
            <input class="value" id="clearNapListAtNight" type="checkbox">
            <span for="clearNapListAtNight" class="translate">clearNapListAtNight</span>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12 m6 l4">
            <input class="value" id="enableDailyNapClear" type="checkbox">
            <span for="enableDailyNapClear" class="translate">enableDailyNapClear</span>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12 m6 l4">
            <i class="material-icons prefix">access_time</i>
            <input class="value" id="forceClearNapListTime" type="text" placeholder="02:45">
            <label for="forceClearNapListTime" class="translate">forceClearNapListTime</label>
          </div>
        </div>
        <div class="row">
          <div class="col s12"><h6>ðŸŒ™ FrÃ¼hschlaf-Filter</h6></div>
        </div>
        <div class="row">
          <div class="input-field col s12 m6 l4">
            <input class="value" id="ignoreEarlyMainSleepEnabled" type="checkbox">
            <span for="ignoreEarlyMainSleepEnabled" class="translate">ignoreEarlyMainSleepEnabled</span>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12 m6 l4">
            <i class="material-icons prefix">schedule</i>
            <input class="value" id="ignoreEarlyMainSleepTime" type="text" placeholder="23:00">
            <label for="ignoreEarlyMainSleepTime" class="translate">ignoreEarlyMainSleepTime</label>
          </div>
        </div>
      </div>

      <!-- DEBUG TAB -->
      <div id="tab-debug" class="col s12 page">
        <div class="row">
          <div class="col s6"><img src="fitbit-fitness.png" alt="logo" class="logo"></div>
        </div>
        <div class="row">
          <div class="input-field col s12 m6 l4">
            <input class="value" id="debugEnabled" type="checkbox">
            <span for="debugEnabled" class="translate">Debug-Ausgabe aktivieren</span>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12 m6 l4">
            <input class="value" id="smartEarlySleepEnabled" type="checkbox">
            <span for="smartEarlySleepEnabled" class="translate">Intelligente FrÃ¼hschlaf-Erkennung</span>
          </div>
        </div>
        <div class="row">
          <div class="input-field col s12 m6 l4">
            <i class="material-icons prefix">access_time</i>
            <input class="value" id="minMainSleepHours" type="number" min="1" max="6" step="0.5" placeholder="3">
            <label for="minMainSleepHours" class="translate">Schwellwert fÃ¼r kurzen Schlaf (Stunden)</label>
          </div>
        </div>
        <div class="row">
         <div class="input-field col s12 m6 l4">
           <i class="material-icons prefix">timelapse</i>
           <input class="value" id="sleepStabilityMinutes" type="number" min="5" max="60" step="1" placeholder="20">
           <label for="sleepStabilityMinutes" class="translate" title="Schlaf-StabilitÃ¤t (Minuten) Tooltip">
           Schlaf-StabilitÃ¤t (Minuten)
          </label>
        </div>
       </div>
      </div> <!-- tab-debug -->
     </div>   <!-- row -->
   </div>     <!-- adapter-container -->
</body>
</html>
